/*!
* ych SPA exchange
*
* Copyright Lynxline LLC, yshurik, 2019-2023,
* Common Clause license https://commonsclause.com/
*/

$( function() {

console.log("Init multisig-evm");

ych.evm_abi_erc20 = [{"inputs":[{"internalType":"string","name":"name_","type":"string"},{"internalType":"string","name":"symbol_","type":"string"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"burn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}];
ych.evm_abi_vault = [{"inputs":[{"internalType":"address","name":"tss_addr","type":"address"},{"internalType":"address","name":"weth_addr","type":"address"},{"internalType":"address[]","name":"add_coins","type":"address[]"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"coin","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"bytes32","name":"state","type":"bytes32"},{"indexed":false,"internalType":"uint256","name":"irev","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"orev","type":"uint256"}],"name":"In","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"coin","type":"address"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bytes32","name":"state1","type":"bytes32"},{"indexed":false,"internalType":"bytes32","name":"state2","type":"bytes32"},{"indexed":false,"internalType":"uint256","name":"irev","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"orev","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"balance","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sigr","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"sigv","type":"uint256"}],"name":"Op","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"bool","name":"reg","type":"bool"}],"name":"Reg","type":"event"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"balances","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"coin","type":"address"},{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"usea","type":"uint256"},{"internalType":"bytes","name":"sig1","type":"bytes"},{"internalType":"uint256","name":"sigr","type":"uint256"},{"internalType":"uint256","name":"sigv","type":"uint256"}],"internalType":"struct Vault7.Use[]","name":"uses","type":"tuple[]"},{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"internalType":"struct Vault7.Fill[]","name":"fills","type":"tuple[]"},{"internalType":"bytes","name":"sig2","type":"bytes"},{"internalType":"uint256","name":"tw","type":"uint256"}],"name":"clearance1","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"coins","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"coin","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"address","name":"user","type":"address"},{"internalType":"bytes","name":"sig1","type":"bytes"}],"name":"deposit1","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"irevs","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"min_amount","type":"uint256"},{"internalType":"bool","name":"on","type":"bool"},{"internalType":"bytes","name":"sig2","type":"bytes"},{"internalType":"uint256","name":"tw","type":"uint256"}],"name":"listCoin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"locktime1","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"locktime2","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"minamount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"orevs","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"bytes","name":"sig1","type":"bytes"},{"internalType":"uint256","name":"tw","type":"uint256"}],"name":"register1","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"user","type":"address"},{"internalType":"bool","name":"on","type":"bool"},{"internalType":"bytes","name":"sig2","type":"bytes"},{"internalType":"uint256","name":"tw","type":"uint256"}],"name":"register2","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"name":"sigr","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"sigv","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"}],"name":"states","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"totals","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"unregister1","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"user","type":"address"},{"internalType":"bytes","name":"sig1","type":"bytes"}],"name":"unregister2","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"users","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ustate","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"coin","type":"address"},{"internalType":"address","name":"user","type":"address"},{"internalType":"address","name":"dest","type":"address"},{"components":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"usea","type":"uint256"},{"internalType":"bytes","name":"sig1","type":"bytes"},{"internalType":"uint256","name":"sigr","type":"uint256"},{"internalType":"uint256","name":"sigv","type":"uint256"}],"internalType":"struct Vault7.Use[]","name":"uses","type":"tuple[]"},{"internalType":"bytes","name":"sig2","type":"bytes"},{"internalType":"uint256","name":"tw","type":"uint256"}],"name":"withdraw1","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"coin","type":"address"},{"internalType":"address","name":"dest","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes","name":"sig2","type":"bytes"}],"name":"withdraw3","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];
ych.evm_zeroaddr = "0x0000000000000000000000000000000000000000";


ych.evm_sign1 = function(user, statehex, amount, addr, tw) {
  const state_data = _ethers.utils.arrayify(statehex);
  const addr2_data = _ethers.utils.arrayify(user);
  const addr3_data = _ethers.utils.arrayify(addr);
  const amount_hex = _ethers.utils.hexZeroPad(_ethers.utils.hexValue(amount), 32);
  const amount_data = _ethers.utils.arrayify(amount_hex);
  const tw_hex = _ethers.utils.hexZeroPad(_ethers.utils.hexValue(tw), 32);
  const tw_data = _ethers.utils.arrayify(tw_hex);
  const in1_data = _ethers.utils.concat([addr2_data, state_data, amount_data, addr3_data, tw_data]);
  const h1 = _ethers.utils.keccak256(in1_data);
  const h1_data = _ethers.utils.arrayify(h1);
  const head = "\x19Ethereum Signed Message:\n32";
  const head_data = _ethers.utils.toUtf8Bytes(head)
  const in2_data = _ethers.utils.concat([head_data, h1_data]);
  const h2 = _ethers.utils.keccak256(in2_data);
  const key = new _ethers.utils.SigningKey("0x"+ych.prvkey1);
  const sig1 = key.signDigest(h2);
  const sig2 = _ethers.utils.joinSignature(sig1);
  return sig2;
};

ych.evm_next_state1 = function(statehex, dest_addr, amount, balance, tw) {
  const state_data = _ethers.utils.arrayify(statehex);
  const addr3_data = _ethers.utils.arrayify(dest_addr);
  const amount_hex = _ethers.utils.hexZeroPad(_ethers.utils.hexValue(amount), 32);
  const amount_data = _ethers.utils.arrayify(amount_hex);
  const tw_hex = _ethers.utils.hexZeroPad(_ethers.utils.hexValue(tw), 32);
  const tw_data = _ethers.utils.arrayify(tw_hex);
  const in1_data = _ethers.utils.concat([state_data, addr3_data, amount_data, tw_data]);
  const h1 = _ethers.utils.keccak256(in1_data);
  return h1;
};

ych.evm_next_state1_old_v2 = function(statehex, dest_addr, amount, balance, tw) {
  const state_data = _ethers.utils.arrayify(statehex);
  const addr3_data = _ethers.utils.arrayify(dest_addr);
  const amount_hex = _ethers.utils.hexZeroPad(_ethers.utils.hexValue(amount), 32);
  const amount_data = _ethers.utils.arrayify(amount_hex);
  const balance_hex = _ethers.utils.hexZeroPad(_ethers.utils.hexValue(balance), 32);
  const balance_data = _ethers.utils.arrayify(balance_hex);
  const tw_hex = _ethers.utils.hexZeroPad(_ethers.utils.hexValue(tw), 32);
  const tw_data = _ethers.utils.arrayify(tw_hex);
  const in1_data = _ethers.utils.concat([state_data, addr3_data, amount_data, balance_data, tw_data]);
  const h1 = _ethers.utils.keccak256(in1_data);
  return h1;
};

// ws

});